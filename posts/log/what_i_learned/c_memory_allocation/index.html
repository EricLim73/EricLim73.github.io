<!DOCTYPE html>
<html lang="en" style="font-size: 100%">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="author" content="Eric Lim">

  
  
  <meta name="description" content="Generic description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://EricLim73.github.io//images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://EricLim73.github.io//images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://EricLim73.github.io//images/favicon-16x16.png">

  
  
  <meta name="keywords" content=''>
  

  
  
  <link rel="stylesheet" href='/katex/katex.min.css'>
<script defer defer src='/katex/katex.min.js'></script>
<script defer src='/katex/contrib/auto-render.min.js'></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          throwOnError : false
        });
    });
</script>
  

  
  

  
  <meta property="og:title" content="C_Memory_Allocation" />
<meta property="og:description" content="Generic description" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://EricLim73.github.io/posts/log/what_i_learned/c_memory_allocation/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-06T14:28:35+09:00" />
<meta property="article:modified_time" content="2024-01-17T20:28:14+09:00" /><meta property="og:site_name" content="YodaModa" />



  
  <link rel="canonical" href="https://EricLim73.github.io/posts/log/what_i_learned/c_memory_allocation/">

  
  
  <meta itemprop="name" content="C_Memory_Allocation">
<meta itemprop="description" content="Generic description"><meta itemprop="datePublished" content="2024-01-06T14:28:35+09:00" />
<meta itemprop="dateModified" content="2024-01-17T20:28:14+09:00" />
<meta itemprop="wordCount" content="11231">
<meta itemprop="keywords" content="C,Memory Allocation," />

  
  
  
    <link rel="stylesheet" href="/css/common.min.69447fa25946f18fd3480042d469fbe68811a406667f4c95d2c0b8911ca8b1c9.css" integrity="sha256-aUR/ollG8Y/TSABC1Gn75ogRpAZmf0yV0sC4kRyosck=" crossorigin="anonymous">
  

  
  
    <link rel="stylesheet" href="/css/content.min.ba38eba94cb47fef9936258c42d11ff19fa9686a30b38e783773fe3f15eb44dc.css" integrity="sha256-ujjrqUy0f&#43;&#43;ZNiWMQtEf8Z&#43;paGows454N3P&#43;PxXrRNw=" crossorigin="anonymous">
  

  
  
  <title>C_Memory_Allocation - YodaModa</title>
  

  
  <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="C_Memory_Allocation"/>
<meta name="twitter:description" content="Generic description"/>


  


  <link rel="stylesheet" href="/css/single.min.be779f459ad7e3aaf8afd0f80c6a61ca6c50993f5f18512532100ac6d93f0fa9.css" integrity="sha256-vnefRZrX46r4r9D4DGphymxQmT9fGFElMhAKxtk/D6k=" crossorigin="anonymous">


  <link rel="stylesheet" href="/css/single.min.78a121b7d7a160420f9daab0ea13add66c37b9c44f27bba07b27207e2b0975d2.css" integrity="sha256-eKEht9ehYEIPnaqw6hOt1mw3ucRPJ7ugeycgfisJddI=" crossorigin="anonymous">


</head>

<body>
  <div id="wrapper">
    


<header id="header">
  <h1>
    <a href="https://EricLim73.github.io/">YodaModa</a>
    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Toggle theme">
        <svg width="2rem" height="2rem" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 496">
        <path fill="currentColor" d="M8,256C8,393,119,504,256,504S504,393,504,256,393,8,256,8,8,119,8,256ZM256,440V72a184,184,0,0,1,0,368Z" transform="translate(-8 -8)"/>
        </svg>
    </button>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M17,11H16a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm0,4H16a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2ZM11,9h6a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2ZM21,3H7A1,1,0,0,0,6,4V7H3A1,1,0,0,0,2,8V18a3,3,0,0,0,3,3H18a4,4,0,0,0,4-4V4A1,1,0,0,0,21,3ZM6,18a1,1,0,0,1-2,0V9H6Zm14-1a2,2,0,0,1-2,2H7.82A3,3,0,0,0,8,18V5H20Zm-9-4h1a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2Zm0,4h1a1,1,0,0,0,0-2H11a1,1,0,0,0,0,2Z"/></svg>
</span>
      
      <a class="link" href="/posts/">Blog</a>
    </span>
    
    <span class="nav-bar-item">
      
        <span class="icon"><svg width="1em" height="1em" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1">
<path d="M10.07031,20.50291a1.00008,1.00008,0,0,0-1.18115-.9834c-1.30908.24024-2.96191.27637-3.40137-.958a5.70754,5.70754,0,0,0-1.83691-2.415,1.20073,1.20073,0,0,1-.1665-.10938,1,1,0,0,0-.93067-.64551H2.54883a.99965.99965,0,0,0-1,.99512c-.00391.81543.811,1.33789,1.1416,1.51465a4.4408,4.4408,0,0,1,.92383,1.35937c.36426,1.02344,1.42285,2.57617,4.46582,2.376.001.03516.00195.06836.00244.09863l.00439.26758a1,1,0,0,0,2,0l-.00488-.31836C10.07715,21.4951,10.07031,21.22068,10.07031,20.50291Zm10.667-15.126c.03174-.125.063-.26367.09034-.41992a6.27792,6.27792,0,0,0-.40821-3.293,1.002,1.002,0,0,0-.61572-.58007c-.356-.12012-1.67041-.35645-4.18408,1.25a13.86918,13.86918,0,0,0-6.354,0C6.76221.751,5.45459.9658,5.10205,1.07908a.99744.99744,0,0,0-.63135.584,6.3003,6.3003,0,0,0-.40332,3.35644c.02442.12793.05078.2461.07813.35449A6.26928,6.26928,0,0,0,2.89014,9.20311a8.42168,8.42168,0,0,0,.04248.92187c.334,4.60254,3.334,5.98438,5.42431,6.459-.04345.125-.083.25878-.11816.40039a1.00023,1.00023,0,0,0,1.94238.47851,1.6784,1.6784,0,0,1,.46778-.87793.99947.99947,0,0,0-.5459-1.74512c-3.4541-.39453-4.95362-1.80175-5.1792-4.89843a6.61076,6.61076,0,0,1-.03369-.73828,4.25769,4.25769,0,0,1,.91943-2.71289,3.022,3.022,0,0,1,.1958-.23145.99988.99988,0,0,0,.188-1.02441,3.3876,3.3876,0,0,1-.15527-.55567A4.09356,4.09356,0,0,1,6.1167,3.06346a7.54263,7.54263,0,0,1,2.415,1.17968,1.00877,1.00877,0,0,0,.82764.13282,11.77716,11.77716,0,0,1,6.17285.001,1.00549,1.00549,0,0,0,.83056-.13769,7.572,7.572,0,0,1,2.40528-1.19043,4.03977,4.03977,0,0,1,.0874,1.57812,3.205,3.205,0,0,1-.16895.60743.9999.9999,0,0,0,.188,1.02441c.07715.08691.1543.18066.22363.26855A4.12186,4.12186,0,0,1,20,9.20311a7.03888,7.03888,0,0,1-.0376.77734c-.22021,3.05566-1.72558,4.46387-5.1958,4.85937a1,1,0,0,0-.54541,1.7461,1.63079,1.63079,0,0,1,.46631.9082,3.06079,3.06079,0,0,1,.09229.81934v2.334C14.77,21.2949,14.77,21.78025,14.77,22.00291a1,1,0,1,0,2,0c0-.2168,0-.69238.00977-1.33984V18.31346a4.8815,4.8815,0,0,0-.15479-1.31153,4.25638,4.25638,0,0,0-.11621-.416,6.51258,6.51258,0,0,0,5.44531-6.42383A8.69677,8.69677,0,0,0,22,9.20311,6.13062,6.13062,0,0,0,20.7373,5.37693Z"/></svg>
</span>
      
      <a class="link" href="https://github.com/EricLim73">GitHub</a>
    </span>
    
  </nav>
</header>
<hr class="head-rule"></hr>
    
<main id="main" class="post">
  
  <div class="post-heading">
    <h1 class="post-title">C_Memory_Allocation</h1>
    <div class="publish-metadata">
      
      <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9H21M7 3V5M17 3V5M6 13H8M6 17H8M11 13H13M11 17H13M16 13H18M16 17H18M6.2 21H17.8C18.9201 21 19.4802 21 19.908 20.782C20.2843 20.5903 20.5903 20.2843 20.782 19.908C21 19.4802 21 18.9201 21 17.8V8.2C21 7.07989 21 6.51984 20.782 6.09202C20.5903 5.71569 20.2843 5.40973 19.908 5.21799C19.4802 5 18.9201 5 17.8 5H6.2C5.0799 5 4.51984 5 4.09202 5.21799C3.71569 5.40973 3.40973 5.71569 3.21799 6.09202C3 6.51984 3 7.07989 3 8.2V17.8C3 18.9201 3 19.4802 3.21799 19.908C3.40973 20.2843 3.71569 20.5903 4.09202 20.782C4.51984 21 5.07989 21 6.2 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      6 January 2024
      
      
        &nbsp;
        <span>
          <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15.4998 5.49994L18.3282 8.32837M3 20.9997L3.04745 20.6675C3.21536 19.4922 3.29932 18.9045 3.49029 18.3558C3.65975 17.8689 3.89124 17.4059 4.17906 16.9783C4.50341 16.4963 4.92319 16.0765 5.76274 15.237L17.4107 3.58896C18.1918 2.80791 19.4581 2.80791 20.2392 3.58896C21.0202 4.37001 21.0202 5.63634 20.2392 6.41739L8.37744 18.2791C7.61579 19.0408 7.23497 19.4216 6.8012 19.7244C6.41618 19.9932 6.00093 20.2159 5.56398 20.3879C5.07171 20.5817 4.54375 20.6882 3.48793 20.9012L3 20.9997Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          11231 words
        </span>
      
      
      
        
      
      
        &nbsp;
        <span>
          <svg width="0.75em" height="0.75em" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 7V12L14.5 13.5M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ~23 mins
        </span>
      
    </div>
  </div>

  
  <div>
    
    <a class="link tag" href='https://EricLim73.github.io/tags/c'>#C</a>
    
    <a class="link tag" href='https://EricLim73.github.io/tags/memory-allocation'>#Memory Allocation</a>
    
    <br></br>
  </div>
  
  
  
  <details>
    <summary>
      <b>Table of Contents</b>
    </summary>
    <div class="toc numbered-subtitles"><nav id="TableOfContents">
  <ul>
    <li><a href="#what-c-uses-to-allocate-memory">What C uses to allocate memory</a>
      <ul>
        <li><a href="#virtualalloc-heapalloc-and-more">VirtualAlloc, HeapAlloc, and more&hellip;</a></li>
      </ul>
    </li>
    <li><a href="#problems-with-traditional-method-of-allocating-memory">Problems with traditional method of allocating memory.</a>
      <ul>
        <li><a href="#raii">RAII</a></li>
        <li><a href="#garbage-collection">Garbage Collection</a></li>
      </ul>
    </li>
    <li><a href="#다른-방법은-없는건가">다른 방법은 없는건가.</a>
      <ul>
        <li><a href="#스택영역">스택영역</a></li>
      </ul>
    </li>
    <li><a href="#arena-allocator">Arena Allocator</a>
      <ul>
        <li><a href="#응용-scratch-arena">(응용) Scratch Arena</a></li>
      </ul>
    </li>
    <li><a href="#마치며">마치며</a></li>
  </ul>
</nav></div>
  </details>
  
  
  <article class="content numbered-subtitles">
    
    <blockquote>
<p>Memory Allocator관련되서 찾다가 배운 내용 정리</p>
</blockquote>
<h1 id="c-allocation-strategy---arena-allocator">C Allocation Strategy - Arena Allocator</h1>
<p>&ldquo;내용 정리&quot;라고 해도 거의 <em><strong><a href="https://www.rfleury.com/p/untangling-lifetimes-the-arena-allocator">Ryan Fleury님의 블로그 글</a></strong></em> 해석을 옮겨 적은 느낌이 더 강하다. 그치만 너무 좋은 내용이였고 실제로 사용해본 결과 꽤 잘돌아간다고 생각해서 해당 블로그 글을 이해하기 위해 공부하며 배운 내용을 정리해본다.<br>
본인이 작성하고 있는 코드들을 최대한 예제로 사용하긴 했는데 이게 전체코드를 모르고 보면 이해가 될지는 장담 못하겠다. 그냥 <code>Arena Allocator</code>의 개념만 이해하면 되니깐 상관없지 않을까&hellip;</p>
<h2 id="what-c-uses-to-allocate-memory">What C uses to allocate memory</h2>
<p><code>malloc()</code> 과 <code>free()</code>는 C에서 제공하는 동적할당 방식이다. <code>malloc()</code>을 통해 원하는 크기에 맞게 heap메모리에서 할당받아 시작주소를 <code>void*</code>로 받는다. <code>free</code>는 <code>malloc()</code>을 통해 얻은 메모리를 더이상 사용하지 않는 공간으로 설정한다. 메모리는 운영체제에서 할당해준다. <code>malloc()</code>의 구현에 따라 동작방식이 조금씩 달르다고 한다. 우선 Win32에서의 동작 방식을 살펴보자.</p>
<h3 id="virtualalloc-heapalloc-and-more">VirtualAlloc, HeapAlloc, and more&hellip;</h3>
<p>우리가 작성하는 프로그램도 결국 운영체제 입장에서는 동작하는 서비스 중 한개일 뿐이다. 동적할당을 어떤 방식으로 작성하든 결국 운영체제와 만나게 되어있다. 윈도우에서 사용되는 코드들은 윈도우 운영체제에게서 부터 메모리를 받아와야되고, 그 작업을 위해 Win32에서 제공하는 함수들인 <code>VirtualAlloc()</code>, <code>HeapAlloc()</code>, 그리고  <code>GlobalAlloc</code> 등이 있다. 여기서 중요하다고 생각되는 두개의 함수, <code>VirtualAlloc()</code>과 <code>HeapAlloc()</code>만 살펴보겠다. 윈도우 환경에서 동적할당을 하게 되면 다음과 같은 프로세스를 거치게 된다.</p>
<blockquote>
<p><code>malloc()</code> -&gt; <code>HeapAlloc()</code> -&gt; <code>VirtualAlloc()</code></p>
</blockquote>
<p>내가 이해한게 맞다면 윈도우 환경에서의 <code>malloc()</code>은 <code>HeapAlloc()</code>을 부르는 형태로 처리된다. 윈도우에서 VisualStudio를 통해 <code>malloc()</code>을 실행해보면 <code>HeapAlloc()</code>로 점프하는 것을 확인할 수 있다. <code>HeapAlloc()</code>는 다시 <code>VirtualAlloc()</code>을 실행한다. 앞에 두 함수는 실질적으로 wrapper 함수가 되는 셈이다. 각 함수들은 다음과 같은 특징을 갖는다.</p>
<ul>
<li>
<p><code>VirtualAlloc()</code><br>
user-mode에서 접근가능한 가장 로우레벨의 함수다. 해당 함수는 커널함수인 <code>ZwAllocateVirtualMemory()</code>을 부른다. 가장 낮은 레벨의 함수이기 때문에 메모리의 <em>예약</em>, <em>할당</em>을 가장 빠르게 처리한다(단순하게 생각해도 함수콜을 2번 생략하는 형태). <code>VirtualAlloc()</code>은 다음 두가지 조건을 만족해야된다.</p>
<ol>
<li>
<p>메모리 블락의 할당은 <code>system granularity boundary</code>에 정렬되는 형태로만 가능하다.</p>
</li>
<li>
<p>메모리 블락의 할당크기는 <code>system granularity boundary</code>에 배수로 정렬되는 크기로만 가능하다.</p>
</li>
</ol>
<p>흔히 운영체제 시간에서 배운 <strong>페이지 단위 할당</strong>이라고 보면 된다. 참고로 <code>system granularity boundary</code>는 Win32의 함수 중 <code>GetSystemInfo()</code>를 통해 확인할 수 있다. 64비트 윈도우 환경에서는 <code>64KB</code>가 나온다. *&ldquo;운영체제에서 배운 페이지의 크기는 분면 4KB였는데 왜 64KB를 주소의 오프셋으로 설정한거지?&quot;*라는 의문은 <a href="https://devblogs.microsoft.com/oldnewthing/20031008-00/?p=42223">Raymond Chen님의 블로그</a>에서 확인할 수 있다 (Win32에 관한 내용에 의문이 든다면 다른 글도 보면 정말 도움된다). 내용을 말도 안되게 짧게 요약하면 할당 중 발생하는 메모리 계산의 속도 향상을 위함이라고 할 수 있다. 결과적으로 할당에 성공하면 리턴값으로 <code>0x10000</code>바이트 경계에 맞는 주소를 받게된다.</p>
<p>그럼 위에서 언급한 <code>예약</code>과 <code>할당</code>을 보자. <code>VirtualAlloc()</code>을 수행하면 <code>system granularity boundary</code>에 맞게 <code>Reserve(예약)</code>을 한다. 실질적으로 메모리를 담지 않지만 운영체제에게 <em>&ldquo;이만큼의 메모리는 사용예정이니 다른 할당을 진행 시 이부분은 건들지 마세요&rdquo;</em> 라고 선언하는 것이다. 반대로 <code>Commit(할당)</code>은 실제로 메모리를 사용하기 위해 예약한 영역을 사용하는 행동이다. 당연하게도 <code>예약</code>된 영역을 다시 <code>예약</code>할 수 없다. <code>할당</code>의 경우 페이지 크기 단위(보통 4KB), 예약의 경우 위에서 언급한 64KB 크기로 스냅핑되어 적용된다. 예를 들어 8바이트를 할당하고자 <code>VirtualAlloc()</code>을 사용하게 되면 운영체제는 64KB를 사용예정으로 플래그를 걸고 4KB만큼을 할당한 다음 그 시작 포인터를 돌려주는 형식이다. 동작하는 원리를 보면 알겠지만 general allocation을 위한 함수는 아니다. 예약 가능한 범위에 대해서도 생각해 볼 필요가 있다. <code>Virtual Address Space</code>라는 개념이 있다. 실제 메모리에 매핑하기 전에 가상 메모리를 매핑받고, 가상메모리가 실제 메모리와 링크되는 형식으로 주소들은 사용된다. 평소에 포인터로 접근하여 보는 주소가 가상 주소를 보고 있는 것이다. 64bit체계에서의 포인터 변수 크기는 주소크기와 같다. 해당 체계에서 가상 메모리로 표현가능한 영역은 0x000'00000000부터 0x7FFF&rsquo;FFFFFFFF로, 총 <strong>128테라바이트</strong>가 된다. 예약은 이 가상메모리 범위 위에서 사용할 크기를 미리 OS에게 알려주어 이후 메모리 할당이 발생할 경우 이전에 예약한 크기만큼의 영역은 이미 사용 중(실제로는 아직 사용X)이라고 말해두는 것이다.</p>
<p>예약과 할당은 함수에 옵션 <code>MEM_RESERVE</code>, <code>MEM_COMMIT</code>을 넣는 것으로 실행할 수 있다. 이렇게 할당한 메모리나 예약한 영역에 대한 반환, 해제는 <code>VirtualFree()</code>함수를 사용한다. 각각의 작업은 생성할때와 마찬가지로 옵션 <code>MEM_DECOMMIT</code>, <code>MEM_RELEASE</code>를 통해 실행한다.</p>
<blockquote>
<p>해당 함수를 통한 할당을 진행할때 사용가능한 옵션 중 하나로 <code>MEM_TOP_DOWN</code>가 있다. 메모리 주소는 큰수에서 높은 수로 올라간다는 사실을 알고 있다면 해당 옵션을 통한 반복된 메모리 할당이 성능에 어떤 문제를 주는지 쉽게 예측 가능할 것이다. 심지어 해당 내용은 함수 설명을 적은 MSDN 글에서도 언급을 하는 내용이다. 자세한 내용은 맨 아래 첨부된 링크를 통해 확인할 수 있다.</p>
</blockquote>
</li>
<li>
<p><code>HeapAlloc()</code>
기본적으로 <code>VirtualAlloc()</code>의 wrapper 역활을 한다. 위 함수를 통한 할당의 경우 <code>HeapCreate()</code>, <code>HeapAlloc()</code>, <code>HeapFree()</code>,<code>HeapDestroy()</code>를 통해 작동한다. Wrapper의 성질이 강하여 작업내용의 경우 <code>VirtualAlloc()</code>과 크게 차이가 나지는 않는다. 특징이 있다면 다음과 같다.</p>
<ol>
<li>
<p>해당 함수를 통해 할당한 메모리는 움직일 수 없다.</p>
</li>
<li>
<p>해당 함수로 받아오는 힙 메모리는 private heap으로 간주되어 시스템이 관여할 수 없다. 즉 해당 메모리는 fragmented(파편화)될 가능성을 갖고 있다.</p>
</li>
<li>
<p>본인이 예약을 건 영역에 존재하는 메모리들을 추적하기 위한 내부 자료구조를 갖고 있다.</p>
</li>
<li>
<p>실사용의 경우 사실 <code>HeapCreate()</code>을 부를 필요는 없다. 자동적으로 하나의 힙이 생성, 제공되며, 해당 힙은 <code>GetProcessHeap()</code>을 통해 얻을 수 있다.</p>
</li>
</ol>
</li>
<li>
<p><code>malloc()</code> / <code>free()</code><br>
C에서 많이 사용하는 메모리 할당 함수이다. CRT 라이브러리에 속한 함수로, 운영체제 별로 내부 구현, 즉 부르는 함수들이 다르다. 윈도우의 경우 HeapAlloc()을 부르게 된다.</p>
</li>
<li>
<p><code>new()</code> / <code>delete()</code>
C++에서 부르는 메모리 할당 함수다. <code>malloc()</code>, <code>free()</code>와 동일하게 <code>HeapAlloc()</code>을 부르게 되고, 추가적으로 C++ 규약을 지키기 위한 추가작업을 진행한다.</p>
</li>
</ul>
<h2 id="problems-with-traditional-method-of-allocating-memory">Problems with traditional method of allocating memory.</h2>
<p>여기서부터  <em><strong><a href="https://www.rfleury.com/p/untangling-lifetimes-the-arena-allocator">Ryan Fleury님의 블로그 글</a></strong></em> 내용이 번역된다고 보면된다. 본인은 지금까지 총 3번정도 해당 글을 읽어봤는데 위에 설명된 윈도우에서 메모리를 할당하는 방법을 알고 읽으면 실제로 본인이 구현할때 이해가 훨씬 잘된다(그냥 내가 멍청해서 처음부터 이해못한 걸 수도 있다). 우선 C에서의 메모리 할당 방식, <code>malloc()</code>과 <code>free()</code>에 대해서 알아보자. C는 버퍼오버플로우, 세그폴트, 포인터 등으로 난이도와 실제로 안정적인 소프트웨어를 제작하는데 소모되는 시간과 노력이 다른 언어들보다 훨씬 높다(개인적으로 그렇게 느낀다). 근데 언어를 배우고 실제로 사용하다보면 위에 언근된 문제들을 대부분 바로 해결되는 사항들이다. 버퍼오버플로우는 컴파일러에서 섀도우스택 기능을 옵션으로 사용하면 왠만하면 해결되고, 포인터는 한국인이라면 바로 이해할 수 있다; 변수는 주민등록증, 안에 저장된 값은 주민등록번호, 가리키는 것은 본인이다. 문제는 세그폴트, 그중에서도 메모리 관련으로 발생하는 문제들이 있다 (세그폴트 말고도 메모리 때문에 발생하는 문제는 많지만 일단 넘어가자&hellip;). 왜 이러한 문제들이 발생할까?</p>
<p>블로그 글을 보면 우선 어떠한 문제들이 있는지 예시와 함께 설명되어 있다. 문제를 요약하자면 할당받은 메모리의 생명주기가 문제의 핵심이라고 글쓴이는 주장한다. 생명주기란 변수가 실제로 효과를 발휘하는 <code>scope</code>를 의미한다(한국어로 저게 맞는 표현인지는 모르겠다). 할당한 메모리가 이전 할당한 메모리에 dependency가 있고, 그 메모리는 할당받은 다른 메모리에 의지해야하고, 그 사이에 일정 메모리는 이제 안쓰니깐 해체를 해야되는데 의존성때문에 해체하지 못하고 계속 들고 있다가 결국 처리하지 못하는 상황이 있다고 보자. 문장을 쓰는 도중에도 본인이 무슨 상황을 설명한지 모를 만큼 복잡한 상황이다. 확실하게 안좋은 상황이라고 할 수 있다. 할당되는 메모리의 생성시점과 종료시점이 코드베이스 전체에 산재되어 있다면 이를 관리하는 작업은 두더기잡기를 눈감고 장소를 외워가며 진행하는 꼴이다.</p>
<p>그럼 왜 이러한 문제가 생기는지를 보자. 프로그래밍 언어도 결국 인터페이스다. 프로그래머는 코딩을 통해 명령어를 만들고, 컴파일하여 운영체제가 실행시킬 수 있는 서비스(실행파일)로 만든다. 어떤 방식을 쓰든 운영체제가 하는 일은 똑같다. 그럼 문제는 언어레벨에 있다고 봐도 괜찬을 것이다. <code>malloc()</code>과 <code>free()</code>는 서로 대칭되게 사용해야된다는 제약이 있다. <em>&ldquo;할당을 했다면 할당받은 메모리를 쓰고 다 사용했다면 해제해라&rdquo;</em> 가 규칙이다. 말이 쉽지 실제 코드를 작성하다보면 여러 시스템 사이에서 위 규칙을 지키는 것은 쉽지않다. 그래서 다른 언어들, C++, Rust, Java와 같은 언어들은 이문제를 해결하기 위해 제각각의 도구를 준비해 준다.</p>
<h3 id="raii">RAII</h3>
<p><em><strong>Resource Acquisition Is Initialization</strong></em>이라는 컨셉은 듣다보면 꽤 말이 되는 것 같다. 정확한 정의를 위해 위키피디아의 설명을 보자.</p>
<blockquote>
<p><em><strong>Resource acquisition is initialization</strong></em> (RAII) is a programming idiom used in several object-oriented, statically typed programming languages to describe a particular language behavior. In RAII, <strong>holding a resource is a class invariant, and is tied to object lifetime</strong>. Resource allocation (or acquisition) is done during object creation (specifically initialization), by the <strong>constructor</strong>, while resource deallocation (release) is done during object destruction (specifically finalization), by the <strong>destructor</strong>. In other words, resource acquisition must succeed for initialization to succeed. Thus the resource is guaranteed to be held between when initialization finishes and finalization starts (holding the resources is a class invariant), and to be held only when the object is alive. Thus if there are no object leaks, there are no resource leaks.</p>
</blockquote>
<p>설명을 들어보면 아주 말이 되는 방식이다. 위에서 설명한 C의 메모리 할당 문제를 정확히 이해하고 해결하고자 한다(만든 사람은 똑똑한 사람이 분명하다). <em>&ldquo;메모리 할당의 생명주기가 문제라면, 그냥 변수(할당받은 메모리)의 생성과 삭제를 <code>scope{}</code>범위에 속해 있는지에 따라 자동으로 만들어버리자! 인간보다 기계가 더 믿을 만하니깐 프로그래머의 실수는 개입할 여지가 없잖아~&rdquo;</em> 라는 발상이다. 이 해결법의 아쉬운 점이 몇가지 있다. 우선 불필요한 코드를 작성해야하고, 불러야된다. 여기서 <strong>불필요</strong>하다는 의미는 쓸모없다가 아니다. 만약 해당 자원인 스코프 밖으로도 잠깐 나가야되는 경우, 이 문제를 해결하기 위한 코드를 따로 작성해줘야 된다(i.e CopyConstructor). C에서의 방식을 벗어나기 위해 오버헤드가 생기는 샘이다(사실 이게 그렇게 큰 영향을 끼치는지는 본인은 잘모르겠다). 더 큰 문제는 이 해결법이 모든 문제를 해결해 주지 않는다는 점이다. <code>RAII</code>의 개념은 <em><strong>오브젝트</strong></em>의 생명주기를 관리하는 것이다. <em>&ldquo;오브젝트가 메모리를 할당하니깐 당연한 소리 아니냐!&rdquo;</em> 라고 할 수 있다. 그런데 작성하는 코드의 모든 영역에서 오브젝트만이 메모리를 사용하는 것도 아니고, 꽤 빈번하게 오브젝트의 생명주기랑은 상관없이 메모리 그 자체가 중요한 경우가 많다. 해당 기능을 위해 언어들은 컴파일타임을 소모하여 코드 생성과 잘못된 사용처리를 막는 작업을 하게 된다.</p>
<h3 id="garbage-collection">Garbage Collection</h3>
<p>이 부분은 학교에서 처음으로 자바를 배울 때도 사실 굳이 필요한가 싶은 기능이긴 했다. 아마 학생 수준의 결과물에서 위력은 커녕 동작하지 않아도 전혀 문제 없었기 때문에 체감이 잘안된 것이라고 생각한다. ***<a href="https://www.rfleury.com/p/untangling-lifetimes-the-arena-allocator">Ryan Fleury님</a>***은 본인보다 훌륭하고 경험도 많은 개발자이고, 그럼에도 불과하고 가비지 컬렉터를 좋게 보지 않는 것 같다. 가비지 컬렉터라는 거창한 이름과 다르게 하는 작업은 단순하다. 지금 할당된 자원들을 리스트로 갖고 있고, 한번씩 쭉 돌아보며 referenced되지 않는 놈을 찾아 쓰레기통으로 보낸다. 이 방법은 세가지 정도 문제점이 있다. 첫째, 딱히 인터페이스의 교정이 없기 때문에 해당 기능이 있음에도 불과하고 메모리 문제는 발생할 수 있다. 둘째, 코드 실행 플로우를 방해한다. 셋째, 이건 첫번째 이유의 결과물로, 만약 코드가 처리하고 버려야될 메모리 할당 핸들은 프로그래머의 부주의로 계속 갖고있다면 가바지 컬렉터는 쓸모가 없어진다.</p>
<h2 id="다른-방법은-없는건가">다른 방법은 없는건가.</h2>
<p>참고하고 있는 블로그 글에서는 위 방법들과 같은 결과를 불러일으킨 사고방식과 왜 그게 미래적인 관점에서 크게 도움이 안되는지를 예쁘게 설명하고 있다. 마음같아선 본인도 그렇게 쓰고 싶지만 부족한 한글실력과 실제로 내용을 100% 이해하고 있다고 말할 수 없기 때문에 해당 내용은 직접가서 보면 좋다.</p>
<p>다른 언어들이 결론을 제시해주지 못한다면 C에서 작업 하지 말라는 소리처럼 들린다. 문제를 다시 생각해 볼 필요가 있다. 문제는 <strong>생명주기</strong>다. 프로그래머로써 우리는 안전하게 메모리에 접근하여 본인들이 작성한 기능이 필요로 하는 만큼 해당 메모리를 제공하다가 정리할 타이밍이 오면 성능부담 없이 깔끔하게 정리하고 싶다. 이러한 기능을 갖고 있는, 모두가 아는 방법이 있다.</p>
<h3 id="스택영역">스택영역</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// LIFETIME A
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="p">{</span><span class="c1">// scope1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">a</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="c1">// scope2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//...do smth with c alongside with a and b...//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// a: who the f*** was &#34;c&#34; again?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// b: idk 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>위 코드를 보면 대충 무슨 말을 하고 싶은지 알 수 있다. 우선 <code>c</code>에 주목하자. <code>c</code>는 <code>scope2</code>에서 나오는 순간 존재하지 않는 변수가 된다. 반대로 저 범위안에서는 얼마든지 사용가능하다. 뭔가 기능이 우리가 원하는 방향과 비슷한 느낌이 든다.  <code>c</code>의 동작방식은 마치 <code>malloc()</code>을 통한 메모리 할등을 한 뒤, 필요한 연산에 사용후 <code>free()</code>로 정리한 것 같다.
<code>a</code>와 <code>b</code>를 보자. 이둘은 <code>scope1</code>, 즉 <strong><code>LifeTime A</code></strong> 동안에는 계속해서 살아있다. 이둘에 의존하는 <code>c</code>가 동작하는데 지장이 없을 정도로 살아있다가, <code>scope1</code>을 벗어나면 없어진다. 뭔가 써먹을 만한 맛있는 냄새가 나기 시작한다. 그렇다고 <code>{}</code>으로 생명주기 경계를 만든다고 해서 모든 상황에 쓸 수 있는 것은 아니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="c1">// scope 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="c1">// scope 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="c1">// scope3    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>위 코드가 가능하다면 꽤 재밌을것 같다. 아쉽게도(?) C에서는 저런 문법을 지원하지 않는다. 스택을 이용한 생명주기 관리가 갖는 한계이기도 하다. 하지만 위 코드가 갖는 아이디어는 쓸만할것 같다. (***<a href="https://www.rfleury.com/p/untangling-lifetimes-the-arena-allocator">블로그 글</a>***에서는 이걸로 <code>stack allocator</code>까지 설명한다)</p>
<h2 id="arena-allocator">Arena Allocator</h2>
<p>위에 스택과 같은 성질을 갖고, 생성시기에 있어 자유도가 높은 allocator를 갖고 싶다. <code>Arena Allocator</code>가 바로 그것이다. 사실 이름은 여러가지 있다(arena allocator, linear allocator, bump allocator 등등). 우선 참고한 블로그 글을 기준으로 설명할 예정이다.</p>
<p>우선 기본적인 인터페이스는 다음과 같다.</p>
<blockquote>
<p>코드 자체는 코드베이스 가이드를 진행하시는 ***<a href="https://www.youtube.com/playlist?list=PLT6InxK-XQvNKTyLXk6H6KKy12UYS_KDL">Mr.4th Programming</a>***의 영상을 참고하여 본인 나름대로 작성해 본 것이다(대부분 영상에서 떠먹여주는 수준으로 설명해준다). 채널 주인분과 Ryan Fleury님이 속한 <em>Dion system</em>에서도 이러한 코드베이스를 이용하여 작업을 하신다고 한다. 실사용 예시를 보고자 한다면 언리얼엔진 그룹 밑에서 개발중인 RAD 디버깅 툴이 영상에 나오는 코드베이스를 기반으로 작성되고 있다. 본인도 영상을 봐가며 몇주간 놀아본 결과 정말 유연한 시스템이고 평소에 짜던 C코드에서 완전 다른 언어를 사용하는 느낌을 받을 정도였다. 디자인의 성공이라고 할 수 있다.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef BASE_MEMORY_H
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BASE_MEMORY_H
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//--Defines--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if !defined(ARENA_COMMIT_REGION_SIZE)
</span></span></span><span class="line"><span class="cl"><span class="cp"># define ARENA_COMMIT_REGION_SIZE KiloByte(4)
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if !defined(ARENA_DECOMMIT_BOUNDARY_SIZE)
</span></span></span><span class="line"><span class="cl"><span class="cp"># define ARENA_DECOMMIT_BOUNDARY_SIZE MegaByte(64)
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#if !defined(DEFAULT_ALIGNMENT)
</span></span></span><span class="line"><span class="cl"><span class="cp"># define DEFAULT_ALIGNMENT 8
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">//--Defines--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//--Types--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">Arena</span> <span class="n">Arena</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">Arena</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">pos</span><span class="p">;</span>        <span class="c1">// available allocation pos (there is no blank after this pos)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">U64</span> <span class="n">commit_pos</span><span class="p">;</span> <span class="c1">// region up to commited pos
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">U64</span> <span class="n">align</span><span class="p">;</span>      <span class="c1">// allocation alignment size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">U64</span> <span class="n">size</span><span class="p">;</span>       <span class="c1">// Total size available for this arena
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">TempArena</span> <span class="n">TempArena</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">TempArena</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//--Types--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//--Arena Functions--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">root_function</span> <span class="n">Arena</span><span class="o">*</span> <span class="nf">ArenaAlloc</span><span class="p">(</span><span class="n">U64</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="n">Arena</span><span class="o">*</span> <span class="nf">ArenaAllocDefault</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span><span class="o">*</span>  <span class="nf">ArenaPushNoZero</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span><span class="o">*</span>  <span class="nf">ArenaPush</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span> <span class="nf">ArenaPopTo</span><span class="p">(</span><span class="n">Arena</span> <span class="o">*</span><span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span> <span class="nf">ArenaSetAutoAlign</span><span class="p">(</span><span class="n">Arena</span> <span class="o">*</span><span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">align</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span> <span class="nf">ArenaPop</span><span class="p">(</span><span class="n">Arena</span> <span class="o">*</span><span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span>   <span class="nf">ArenaRelease</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span>   <span class="nf">ArenaClear</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//--Arena Functions--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//--Arena Macro--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SetArenaAlign(arena, align) Statement(arena-&gt;align = align;)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PushArrayNoZero(arena, type, count) (type*)ArenaPushNoZero(arena, sizeof(type) * count)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PushArray(arena, type, count) (type*)ArenaPush(arena, sizeof(type) * count)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//--Arena Macro--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//--Temp Functions--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">root_function</span> <span class="n">TempArena</span> <span class="nf">TempBegin</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span> <span class="nf">TempPop</span><span class="p">(</span><span class="n">TempArena</span> <span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//--Temp Functions--
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif </span><span class="c1">//BASE_MEMORY_H
</span></span></span></code></pre></div><p>구현된 C 파일은 다음과 같다. 설명하는데 구현도 같이 보는게 쉽다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// NOTE(EricLim): return pointer for arena. 
</span></span></span><span class="line"><span class="cl"><span class="c1">// First get a chunk of memory that is reserved and 
</span></span></span><span class="line"><span class="cl"><span class="c1">// commited(bigger than sizeof(Arena)), use the first
</span></span></span><span class="line"><span class="cl"><span class="c1">// sizeof(Arena) amount of portion to save settings(just like malloc)
</span></span></span><span class="line"><span class="cl"><span class="c1">// and return the ptr back. Allocation with this arena starts from
</span></span></span><span class="line"><span class="cl"><span class="c1">// arena-&gt;pos, which points to the next address right after setting values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">root_function</span> <span class="n">Arena</span><span class="o">*</span> 
</span></span><span class="line"><span class="cl"><span class="nf">ArenaAlloc</span><span class="p">(</span><span class="n">U64</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// snapping input size to fit 64KB unit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">U64</span> <span class="n">snapping_factor</span> <span class="o">=</span> <span class="nf">MegaByte</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">+=</span> <span class="n">snapping_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span> <span class="o">-=</span> <span class="n">size</span> <span class="o">%</span> <span class="n">snapping_factor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">memory</span> <span class="o">=</span> <span class="nf">OS_Reserve</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">initial_commit_size</span> <span class="o">=</span> <span class="n">ARENA_COMMIT_REGION_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Assert(initial_commit_size &gt; sizeof(Arena));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">OS_Commit</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">initial_commit_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span> <span class="o">=</span> <span class="p">(</span><span class="n">Arena</span><span class="o">*</span><span class="p">)</span><span class="n">memory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">arena</span><span class="o">-&gt;</span><span class="n">commit_pos</span> <span class="o">=</span> <span class="n">initial_commit_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">arena</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">=</span> <span class="n">DEFAULT_ALIGNMENT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">arena</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">arena</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="n">Arena</span><span class="o">*</span> 
</span></span><span class="line"><span class="cl"><span class="nf">ArenaAllocDefault</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Reserve up to 4Gb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because its only reserving, and virtual memory address space
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is like over hundred terabytes, so no problem in 64bit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">ArenaAlloc</span><span class="p">(</span><span class="nf">GigaByte</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// NOTE(EricLim): Originally tried to make so that 
</span></span></span><span class="line"><span class="cl"><span class="c1">// we return arena-&gt;pos and calculate arena-&gt;pos 
</span></span></span><span class="line"><span class="cl"><span class="c1">// by input_size + align, but if commit size was big
</span></span></span><span class="line"><span class="cl"><span class="c1">// enough, the result actually going to have size+align
</span></span></span><span class="line"><span class="cl"><span class="c1">// so we need to calculate alignment before setting result pos
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">root_function</span> <span class="kt">void</span><span class="o">*</span> 
</span></span><span class="line"><span class="cl"><span class="nf">ArenaPushNoZero</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// base ptr point for pointer calculation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">U8</span><span class="o">*</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">U8</span><span class="o">*</span><span class="p">)</span><span class="n">arena</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">U64</span> <span class="n">aligned_pos</span> <span class="o">=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">aligned_pos</span> <span class="o">+=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">aligned_pos</span> <span class="o">-=</span> <span class="n">aligned_pos</span> <span class="o">%</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">U64</span> <span class="n">align</span> <span class="o">=</span> <span class="n">aligned_pos</span> <span class="o">-</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">align</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">align</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">arena</span><span class="o">-&gt;</span><span class="n">commit_pos</span> <span class="o">&lt;</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// NOTE(EricLim): We dont need to do this snapping for windows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// bc the page size is the default commit_region_size but just doing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// for cases when this becomes false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">U64</span> <span class="n">update_commit</span> <span class="o">=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">commit_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">update_commit</span> <span class="o">+=</span> <span class="n">ARENA_COMMIT_REGION_SIZE</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">update_commit</span> <span class="o">-=</span> <span class="n">update_commit</span> <span class="o">%</span> <span class="n">ARENA_COMMIT_REGION_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="nf">OS_Commit</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">commit_pos</span><span class="p">,</span> <span class="n">update_commit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">arena</span><span class="o">-&gt;</span><span class="n">commit_pos</span> <span class="o">+=</span> <span class="n">update_commit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO(EricLim): Will implement link inside arena for growing arena
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">Assert</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span><span class="o">*</span> 
</span></span><span class="line"><span class="cl"><span class="nf">ArenaPush</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="nf">ArenaPushNoZero</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MemoryZero</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="nf">ArenaPopTo</span><span class="p">(</span><span class="n">Arena</span> <span class="o">*</span><span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">pop_limit</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="nf">Max</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pop_limit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// find align new arena-&gt;pos
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// NOTE(EricLim): we DO NOT update arena-&gt;pos with this value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// arena-&gt;pos gets aligned right before insertion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">U64</span> <span class="n">aligned_pos</span> <span class="o">=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">ARENA_COMMIT_REGION_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">aligned_pos</span> <span class="o">-=</span> <span class="n">aligned_pos</span> <span class="o">%</span> <span class="n">ARENA_COMMIT_REGION_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">aligned_pos</span> <span class="o">+</span> <span class="n">ARENA_DECOMMIT_BOUNDARY_SIZE</span> <span class="o">&lt;=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">commit_pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// NOTE(EricLim): the only explaination i have with this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// is that if there is too much memory being commited,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// over the boundary that we specified, then we decommit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// The size of decommit_size doesn&#39;t need to care about
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// alignment because aligned_pos did that part already
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">U8</span><span class="o">*</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">U8</span><span class="o">*</span><span class="p">)</span><span class="n">arena</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">U64</span> <span class="n">decommit_size</span> <span class="o">=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">commit_pos</span> <span class="o">-</span> <span class="n">aligned_pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">OS_Decommit</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">aligned_pos</span><span class="p">,</span> <span class="n">decommit_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">arena</span><span class="o">-&gt;</span><span class="n">commit_pos</span> <span class="o">-=</span> <span class="n">decommit_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="nf">ArenaPop</span><span class="p">(</span><span class="n">Arena</span> <span class="o">*</span><span class="n">arena</span><span class="p">,</span> <span class="n">U64</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">pop_limit</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">pop_range</span> <span class="o">=</span> <span class="nf">Min</span><span class="p">(</span><span class="n">pop_limit</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">new_pos</span> <span class="o">=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">pop_range</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">new_pos</span> <span class="o">=</span> <span class="nf">Max</span><span class="p">(</span><span class="n">new_pos</span><span class="p">,</span> <span class="n">pop_range</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ArenaPopTo</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">ArenaRelease</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">OS_Release</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="nf">ArenaClear</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// puff all the way back
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ArenaPopTo</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Arena</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// For temporary arena -&gt; mostly for scratch arena
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">root_function</span> <span class="n">TempArena</span> 
</span></span><span class="line"><span class="cl"><span class="nf">TempBegin</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TempArena</span> <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span><span class="p">.</span><span class="n">arena</span> <span class="o">=</span> <span class="n">arena</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="kt">void</span> 
</span></span><span class="line"><span class="cl"><span class="nf">TempPop</span><span class="p">(</span><span class="n">TempArena</span> <span class="n">temp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ArenaPopTo</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">arena</span><span class="p">,</span> <span class="n">temp</span><span class="p">.</span><span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>잘 설명할 수 있을지 모르겠지만, 결과적으로 <code>arena allocator</code>는 그냥 한번에 크게 메모리를 할당받고 그 영역을 스택처럼 관리하면서 메모리 할당이 필요할 때마다 받아놓은 메모리에 위치 포인터를 반환하고 위치를 할당한 크기만큼 옮기는게 끝이다.
<code>ArenaAlloc()</code>은 <code>VirtualAlloc()</code>의 기능을 이용하여 작동한다. 코드의 주석에 대략의 동작과정을 적어놨다. 입력된 크기만큼을 일정 offset에 맞게 스냅핑하고 그만큼을 예약한다. 실제 할당은 작동하는 운영체제의 페이지 단위로 적용된다. 할당받은 포인터에서 <code>Arena</code>정보를 담을 수 있게 캐스팅하여 헤더 내용을 적고, 끝부분의 포인터를 반환한다. 할당을 받기 위해서는 <code>ArenaPush()</code>를 통해 진행된다. <code>Arena</code>안에 존재하는 <code>pos</code>를 반환하고, 사용할 크기만큼 <code>pos</code>를 이동시킨다. 만약 이동된 위치, 정확히는 현재 커밋되어 있는 영역이 모자르면 예약을 걸어놓은 영역에서 일정부분을 할당받아온다. <code>Arena</code>에 올린 내용 중 더이상 사용하지 않는 내용은 <code>ArenaClean</code>을 쓰면 된다. 실제로 할당된 메모리를 비우기보단 <code>pos</code>의 위치만을 이동시켜 다음 할당에서는 기존 데이터(더이상 사용않하는 데이터)를 덮어쓰기하는 형태다. 더이상 <code>Arena</code>를 사용하지 않는다면 <code>ArenaRelease()</code>를 불러주면 된다. 처음에 Mr.4th Programming의 영상과 Ryan Fleury님의 블로그 글을 아무리 봐도 이게 왜 위에서 봤던 스택의 특성을 갖고 있다는지 이해되지 않았다. 실제로 사용하다보면 이해가 쉬워진다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">String8</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">U8</span><span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">U64</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">root_function</span> <span class="n">String8</span> 
</span></span><span class="line"><span class="cl"><span class="nf">PushStr8Copy</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">,</span> <span class="n">String8</span> <span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">String8</span> <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="nf">PushArray</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span> <span class="n">U8</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MemoryCopy</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// when used in index its actually + 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (*** index starts from 0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">result</span><span class="p">.</span><span class="n">str</span><span class="p">[</span><span class="n">result</span><span class="p">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Arena</span><span class="o">*</span> <span class="n">system_arena</span> <span class="o">=</span> <span class="nf">ArenaAlloc</span><span class="p">(</span><span class="nf">Kilobytes</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">U32</span><span class="o">*</span> <span class="n">uint32_arr</span> <span class="o">=</span> <span class="nf">PushArray</span><span class="p">(</span><span class="n">system_arena</span><span class="p">,</span> <span class="n">U32</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">U32</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">idx</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">;</span><span class="o">++</span><span class="n">idx</span><span class="p">){</span><span class="n">uint32_arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">=</span><span class="n">idx</span><span class="p">;}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">U32</span> <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">idx</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">;</span><span class="o">++</span><span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">uint32_arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span><span class="o">*</span> <span class="n">abc</span> <span class="o">=</span> <span class="nf">Str8Lit</span><span class="p">(</span><span class="s">&#34;abc&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">String8</span> <span class="n">test</span> <span class="o">=</span> <span class="p">{</span><span class="n">abc</span><span class="p">,</span> <span class="nf">calculateCStringSize</span><span class="p">(</span><span class="n">abc</span><span class="p">)};</span>
</span></span><span class="line"><span class="cl">    <span class="n">String8</span> <span class="n">test_clone</span> <span class="o">=</span> <span class="nf">PushStr8Copy</span><span class="p">(</span><span class="n">system_arena</span><span class="p">,</span> <span class="n">test</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PrintStr8</span><span class="p">(</span><span class="n">test_clone</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">ArenaRelease</span><span class="p">(</span><span class="n">system_arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>간단한 사용예제다. 사실 이코드만 보면 이게 <code>malloc()</code>이나 <code>free()</code>와 다른게 별로 없어보인다. 이건 해당 내용에 관해 설명하는 다른 영상들에도 달리는 단골 멘트인데, &ldquo;저건 그냥 기존의 <code>malloc()</code>과 <code>free()</code>를 더 복잡하게 바꾼거지 딱히 달라진것도 없고, 결국 본인이 직접 메모리를 만진다는 사실에는 변함이 없기 때문에 위험도는 오히려 더 높아졌다&quot;라는 방향성의 의견들을 많이 접할 수 있다(그러면서 넌지시 Rust난 C++을 하라고 강요한다). &ldquo;여기서 <code>ArenaRelease()</code>라는 함수가 뭔지는 모르지만 이름만 보면 <code>free()</code>의 기능인데, 이거 안쓰면 그대로 메모리 누수 아니냐!&rdquo; 라는 주장이 가장 대표적이다. 여기서 2가지 사실을 알 필요가 있다. 우선 예시이긴 하지만 위 코드를 잘보면, <code>ArenaRelease()</code>를 쓴 다음 바로 리턴을 하며 메인 함수는 끝난다. **<code>system_arena</code>**의 경우 프로세스가 실행하는 동안 계속 사용되다가 프로그램이 종료되면 자동으로 스택에서 없어지고, <code>VirtualAlloc()</code>을 통해 들고 있던 메모리의 경우 운영체제가 자원관리를 하며 정리한다. 운영체제가 마치 커다란 <em><strong>가비지 컬렉터</strong></em>인 셈이다. 그렇다고 위 인터페이스를 전통적인 C의 메모리 할당 방식처럼 사용하면 의미가 없어진다(해본 결과 터지기도 한다). 구현된 인터페이스에는 사용방법이 녹아있다고 봐야된다. <code>Arena Allocator</code>는 스택에 존재하는 일반적인 변수로써의 성질을 갖고 있다. 앞서 설명한 &ldquo;<code>scope</code>에서 벗어나면 <code>system_arena</code>가 소멸한다&quot;라는 내용이다. 이 특징을 살려 사용한다면 다음과 같은 생명주기를 관찰할 수 있다.</p>
<pre><code>                       arena3[-------------------------------------------------]
        arena1[--------------]         arena2[--------------]
arena_main[--------------------------------------------------------------------]
           시작                                                                끝
</code></pre>
<p>위 그림을 게임에 비교해보자. <em>arena_main</em>의 경우 게임의 시작부터 종료까지 계속 존재하는 영역이다. 기본적인 시스템에 필요한 자원은 여기서 할당 받으면 된다. <em>arena1</em>은 초기 리소스를 받아오는 시스템에서 사용하는 영역이라고 가정하자(실제로 게임이 이러한 순서로 동작하는지 모른다). <em>arena1</em>가 필요로 하는 파일경로 같은 정보가 <em>arena_main</em>에 있어도 가져오는데 전혀 문제가 없다. <em>arena2</em>의 경우 게임 도중에 저장을 하기 위해 잠깐 사용하는 영역이고, <em>arena3</em>는 사운드나 그래픽 시스템에서 사용하는 메모리라고 가정하자. 우리가 원하던 **&ldquo;동적 메모리 할당에 생명주기의 개념&rdquo;**이 추가되었고, 생성하는 타이밍도 자유롭게 정할 수 있다. <em>arena3</em>을 사용하는 작업을 하는 도중 절대 <em>arena_main</em>이 사라지거나 접근조차 못하게 되는 것이다. 실수로 해당 메모리를 없에고 싶어도 <em>arena3</em>이 동작하는 시스템은 <em>arena_main</em>이 살아있는 콜스택에서 한참은 떨어져 있는 코드에 존재하기 때문이다. 원본 블로그 글보다 설명이 어설프긴 하지만 커다란 개념은 위에 그린 도표가 전부다.<br>
만약 아직도 &ldquo;그래도 만약 저중에 하나라도 <code>ArenaRelease()</code>를 안하면 메모리 누수가 터지지 않냐!&ldquo;라고 한다면 뭐라고 설명해야될지 본인의 능력으로는 생각이 나지 않는다. <em>&ldquo;printf(&quot;%d&rdquo;)라고 쓰고 뒤에 인수를 입력안하면 위험하니깐 어떤 방법이든 C언어는 고칠수 없다! 빨리 C++ || Rust으로 넘어와라~&rdquo;</em> 라는 소리처럼 들린다.<br>
<code>malloc()</code> 과 <code>free()</code>와 다른점은 이 두함수는 반환하는 메모리 포인터 이외에 것에는 흥미가 없는 반면, <code>Arena Allocator</code>를 사용하면 메모리 할당이 곧 콜스택에 쌓이는, 생명주기가 확실하게 존재하는 변수로써의 의미를 갖게 된다. 이 시점까지 오면 C의 파일 입출력 함수인 <code>fopen()</code>, <code>fclose()</code>같은 형태가 된다. 이 두함수를 가지고 &ldquo;???: 부르는 것을 까먹으면 프로그램이 터지는 위험한 함수&quot;라며 C언어 사용을 하지 말라고 하는 개발자는 본적이 없다.<br>
본인의 실전경험 부족과 지식에 한계로 위에 설명한 내용이 적절한 설명인지 확신할 수는 없지만 최소한 해당 주제에 대해 공부하면서 스스로 느낀 내용과 맞게 설명할 것 같다.</p>
<h3 id="응용-scratch-arena">(응용) Scratch Arena</h3>
<p>앞서 작성한 구현코드를 보면 <code>TempArena</code>라는 구조체가 있다. 이는 잠깐 사용하고 버리는 용도의 메모리 영역이 필요해서 만들어진 구조체다. 예를 들어 기존 문자열에서 일부분을 뜯어서 고친 다음 다시 저장하고 싶다고 하자.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">root_function</span> <span class="n">B32</span> 
</span></span><span class="line"><span class="cl"><span class="nf">OS_FileExist</span><span class="p">(</span><span class="n">String8</span> <span class="n">path</span><span class="p">,</span> <span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// UTF8 문자열을 UTF16으로 변환하고 이를 반환한다. Str 타입들은 포인터로 문자열을 가르키고 size으로 길이를 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 저장하는 구조다. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">String16</span> <span class="n">path16</span> <span class="o">=</span> <span class="nf">Str16FromStr8</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// no need to store actual data so retrieve point is null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">B32</span> <span class="n">isAttribAvailable</span> <span class="o">=</span> <span class="nf">GetFileAttributesW</span><span class="p">((</span><span class="n">WCHAR</span><span class="o">*</span><span class="p">)</span><span class="n">path16</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">isAttribAvailable</span> <span class="o">!=</span> <span class="n">INVALID_FILE_ATTRIBUTES</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="o">!</span><span class="p">(</span><span class="n">isAttribAvailable</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE_DIRECTORY</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>위 함수가 있다고 생각해보자. 동작하는데 문제는 없지만, <em>arena</em>안에 검사만 하고 사용하지 않을 문자열이 남게된다. 굳이 이런 낭비를 할 필요가 전혀 없다. <code>Scratch arena</code>는 그냥 위에서 설명한 일반적인 <code>arena allocator</code>를 하나 글로벌 변수로 두고 이를 임시 저장소처럼 사용하자는 내용이다. 물론 여기서 중요한 점은 그냥 전역변수가 아닌 thread independent한 전역변수를 두는 것이다. 쓰레드 별로 본인만의 임시 <code>scratch arena</code>를 사용해야지 나중에 멀티스레드 특유의 문제들이 안생긴다(고 한다).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// in tctx.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ThreadCtx</span> <span class="n">ThreadCtx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">ThreadCtx</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Arena</span><span class="o">*</span> <span class="n">scratch_arenas</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">B32</span> <span class="n">is_main_thread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// in tctx.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">per_thread</span> <span class="n">ThreadCtx</span> <span class="o">*</span><span class="n">tl_tctx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></div><p><code>per_thread</code>의 경우 운영체제, 사용하는 컴파일러에 따라 다른 형식어가 있다(저건 그냥 매크로로 지금 컴파일러에 맞게 매핑되는 키워드다). 이 전역변수는 프로세스가 시작하면 바로 초기화 해주면 된다. 그럼 이걸 사용하여 위에 코드를 고쳐보자.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">root_function</span> <span class="n">B32</span> 
</span></span><span class="line"><span class="cl"><span class="nf">OS_FileExist</span><span class="p">(</span><span class="n">String8</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TempArena</span> <span class="n">scratch</span> <span class="o">=</span> <span class="nf">ScratchBegin</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">String16</span> <span class="n">path16</span> <span class="o">=</span> <span class="nf">Str16FromStr8</span><span class="p">(</span><span class="n">scratch</span><span class="p">.</span><span class="n">arena</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// no need to store actual data so retrieve point is null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">B32</span> <span class="n">isAttribAvailable</span> <span class="o">=</span> <span class="nf">GetFileAttributesW</span><span class="p">((</span><span class="n">WCHAR</span><span class="o">*</span><span class="p">)</span><span class="n">path16</span><span class="p">.</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">ScratchEnd</span><span class="p">(</span><span class="n">scratch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">isAttribAvailable</span> <span class="o">!=</span> <span class="n">INVALID_FILE_ATTRIBUTES</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="o">!</span><span class="p">(</span><span class="n">isAttribAvailable</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE_DIRECTORY</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>이렇게 한번 쓰고 바로 정리해버리는 구조다. <code>ScratchBegin()</code>의 구현은 위에서 언급한 전역변수인 스레드 컨텍스트에서 아레나를 하나 받아오는 것이다. 근데 위에서 <code>ThreadCtx</code>를 잘보면 아레나가 2개로 이루어진 배열이다. 이는 다음과 같은 문제를 해결하기 위함이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">boo</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">work</span> <span class="o">=</span> <span class="nf">PushArena</span><span class="p">(...)</span> <span class="c1">// A
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TempArena</span> <span class="n">scratch</span> <span class="o">=</span> <span class="nf">ScratchBegin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do some work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// -&gt; aka saving the work inside the arena region (because of line A) 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ScratchEnd</span><span class="p">(</span><span class="n">scratch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TempArena</span> <span class="n">scratch</span> <span class="o">=</span> <span class="nf">ScratchBegin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//do some work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="nf">boo</span><span class="p">(</span><span class="n">scratch</span><span class="p">.</span><span class="n">arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//do some more work with scratch..........&gt;this is where problem gets big
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ScratchEnd</span><span class="p">(</span><span class="n">scratch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>만약 <code>ThreadCtx</code>안에 아레나가 하나밖에 없다고 하자. <code>foo</code>에서 사용한 scratch arena를 입력으로 받은 함수 <code>boo</code>가 본인이 작업에 임시로 사용할 아레나를 위해 ScratchBegin()를 부른다. 현재 설계상 받아온 녀석은 <code>foo</code>가 사용하는 아레나와 동일한 것이 된다. <code>boo()</code>는 본인이 임시 아레나에서 작업한 내용을 입력받은 아레나에 저장한다. 만약 여기서 ScratchEnd(scratch)를 한다고 해보자. 참고로 <code>ScratchEnd()</code>는 <code>TempPop</code>를 가르키는 매크로함수다. <code>TempPop()</code>에 따라 아레나가 pop되버리면 나중에 <code>foo</code>로 돌아가 <code>boo</code>가 작업하여 저장한 내용에 접근하고자 하면  아무것도 없는, 즉 <code>boo</code>가 본인이 만든 작업물을 본인이 없에는 상황이 된다. 결국 파라미터로 입력받은 <code>arena</code>와 함수로 받은 <code>scratch.arena</code>가 같은 녀석이라는 것이 문제다. 이러한 문제를 해결하기 위해 <code>ThreadCtx</code>에 최소 2개의 아레나를 들고 있게 한다는 것이다. 만약 본인이 받은 파라미터의 <code>*arena*</code>가 잠시 사용중인 <code>TempArena</code>인지 확인하고 싶다면 <code>ScratchBegin(받은 아레나, 개수)</code>를 사용하면 된다. 지금 전역변수인 <code>tl_tctx</code>를 통해 충돌되는지 확인하고, 괜찮다면 배열 안에 2개중 한개를 받아오면 된다. 그럼 왜 하필 최소 2개인가?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">boo2</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">work</span> <span class="o">=</span> <span class="nf">PushArena</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl">    <span class="n">TempArena</span> <span class="n">scratch</span> <span class="o">=</span> <span class="nf">ScratchBegin</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do some work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ScratchEnd</span><span class="p">(</span><span class="n">scratch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">foo2</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TempArena</span> <span class="n">scratch</span> <span class="o">=</span> <span class="nf">ScratchBegin</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//do some work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="nf">boo2</span><span class="p">(</span><span class="n">scratch</span><span class="p">.</span><span class="n">arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//do some more work with scratch..........&gt;this is where problem gets big
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ScratchEnd</span><span class="p">(</span><span class="n">scratch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">boo1</span><span class="p">(</span><span class="n">Arena</span><span class="o">*</span> <span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span><span class="o">*</span> <span class="n">work</span> <span class="o">=</span> <span class="nf">PushArena</span><span class="p">(...)</span>
</span></span><span class="line"><span class="cl">    <span class="n">TempArena</span> <span class="n">scratch</span> <span class="o">=</span> <span class="nf">ScratchBegin</span><span class="p">(</span><span class="n">arean</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do some work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">foo2</span><span class="p">(</span><span class="n">scratch</span><span class="p">.</span><span class="n">arena</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ScratchEnd</span><span class="p">(</span><span class="n">scratch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">work</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">foo1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TempArena</span> <span class="n">scratch</span> <span class="o">=</span> <span class="nf">ScratchBegin</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//do some work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="nf">boo</span><span class="p">(</span><span class="n">scratch</span><span class="p">.</span><span class="n">arena</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//do some more work with scratch..........&gt;this is where problem gets big
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ScratchEnd</span><span class="p">(</span><span class="n">scratch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>이러한 상황이라고 생각해보자(더 추가해도 문제없다). 문제가 되는 것은 <code>foo1</code>과 <code>boo1</code>, <code>foo2</code>와 <code>boo2</code> 사이의 관계다. 만약 <code>foo1</code>과 <code>foo2</code>가 같은 scratch arena를 받았다고 가정하자. <code>foo2</code>의 작업결과는 본인을 부른 <code>boo1</code>이 받아가고, <code>foo1</code>은 오히려 본인 앞에 있던 임시 데이터가 정리되어 다음에 본인이 데이터를 정리하고자 한다면 실제로 본인이 받아간 메모리를 돌려줄 수 있게 된다(다시 강조하지만 여기서 돌려주는건 그냥 위치 포인터를 옮긴다는 것이지 진짜 메모리 작업을 하지는 않는다). <code>ScratchBegin()</code>의 구현은 다음과 같다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">root_function</span> <span class="n">TempArena</span> 
</span></span><span class="line"><span class="cl"><span class="nf">ScratchBegin</span><span class="p">(</span><span class="n">Arena</span><span class="o">**</span> <span class="n">available_arenas</span><span class="p">,</span> <span class="n">U64</span> <span class="n">conflict_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">TempArena</span> <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">ThreadCtx</span><span class="o">*</span> <span class="n">tctx</span> <span class="o">=</span> <span class="nf">GetThreadCtx</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">U32</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nf">ArrayCount</span><span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">scratch_arenas</span><span class="p">);</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">B32</span> <span class="n">conflicting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">U32</span> <span class="n">arena_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">arena_idx</span> <span class="o">&lt;</span> <span class="n">conflict_count</span><span class="p">;</span> <span class="o">++</span><span class="n">arena_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">available_arenas</span><span class="p">[</span><span class="n">arena_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">scratch_arenas</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">conflicting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">conflicting</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">temp</span><span class="p">.</span><span class="n">arena</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">scratch_arenas</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">temp</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">arena</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="마치며">마치며</h2>
<p>메모리 전반에 내용과 컴퓨터구조, 더 나아가 API 디자인에 대해 배울 수 있는 좋은 기회였다. 정리하는데 너무 시간을 많이 잡아먹은 것이 아쉽다. 해당 내용을 이해하기 위해 공부하던 도중 찾은 <em><strong><a href="https://www.youtube.com/watch?v=nZNd5FjSquk&amp;t=809s">Cppcon 2017 - John Lakos: &ldquo;Local(arena) Memory Allocators&rdquo;</a></strong></em> 영상은 정말 많은 도움이 됐다. 발표자분이 재밌게 진행해 주신것도 있지만 메모리 접근과 캐시에 미치는 allocator의 성능에 정말 세세한 부분까지 깊게 파고들며 강연해주신다. 그외에 공부하면서 도움이 된 레퍼런스는 아래 기재했다.<br>
이번 공부를 통해 알게된 <em><strong><a href="https://www.youtube.com/playlist?list=PLT6InxK-XQvNKTyLXk6H6KKy12UYS_KDL">Mr.4th Programming</a></strong></em> 덕분에 본인만에 코드베이스를 만들 수 있던 것도 너무 좋았다. 지금 계속 밀리고 있는 Vulkan관련 포스트도 해당 코드베이스에서 구현하여 작성할 생각이다.</p>
<p><strong>Reference</strong></p>
<p><em><strong><a href="https://www.rfleury.com/p/untangling-lifetimes-the-arena-allocator">Arena Allocator</a></strong></em><br>
<em><strong><a href="https://www.youtube.com/playlist?list=PLT6InxK-XQvNKTyLXk6H6KKy12UYS_KDL">Mr.4th Programming</a></strong></em><br>
<em><strong><a href="https://www.youtube.com/watch?v=nZNd5FjSquk&amp;t=809s">Cppcon 2017 - John Lakos: &ldquo;Local(arena) Memory Allocators&rdquo;</a></strong></em></p>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc()</a><br>
<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/virtual-address-spaces">VirtualAddressSpace</a><br>
<a href="https://stackoverflow.com/questions/872072/whats-the-differences-between-virtualalloc-and-heapalloc">StackOverflow -&gt; MemoryAllocation</a><br>
<a href="https://randomascii.wordpress.com/2011/08/05/making-virtualalloc-arbitrarily-slower/">VirtualAlloc can be slow</a></p>
    
  </article>

  <button onclick="topFunction()" id="back-to-top" title="Go to top">Back to Top</button>

  

<div id="sharingbuttons">
    
    
    <a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fEricLim73.github.io%2fposts%2flog%2fwhat_i_learned%2fc_memory_allocation%2f" target="_blank" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg>
        </div>
      </div>
    </a>
    

    
    
    <a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?text=C_Memory_Allocation&amp;url=https%3a%2f%2fEricLim73.github.io%2fposts%2flog%2fwhat_i_learned%2fc_memory_allocation%2f" target="_blank" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5 0-4.55 2.04-4.55 4.54 0 .36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3 0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35 0 12.92-6.92 12.92-12.93 0-.2 0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg>
        </div>
      </div>
    </a>
    

    
    
    <a class="resp-sharing-button__link" href="mailto:?subject=C_Memory_Allocation&amp;body=https%3a%2f%2fEricLim73.github.io%2fposts%2flog%2fwhat_i_learned%2fc_memory_allocation%2f" target="_self" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 4H2C.9 4 0 4.9 0 6v12c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17 0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1 0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08 0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z"/></svg>
        </div>
      </div>
    </a>
    

    
    
    <a class="resp-sharing-button__link" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fEricLim73.github.io%2fposts%2flog%2fwhat_i_learned%2fc_memory_allocation%2f" target="_blank" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6 0 2.5 1 2.6 2.5 0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z"/></svg>
        </div>
      </div>
    </a>
    

    
    
    <a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https%3a%2f%2fEricLim73.github.io%2fposts%2flog%2fwhat_i_learned%2fc_memory_allocation%2f&amp;resubmit=true&amp;title=C_Memory_Allocation" target="_blank" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96 0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65 0 3-1.35 3-3s-1.35-3-3-3c-1.38 0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65 0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66 0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64 0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4 0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6 0 .23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1 0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg>
        </div>
      </div>
    </a>
    

    
    
    <a class="resp-sharing-button__link" href="whatsapp://send?text=https%3a%2f%2fEricLim73.github.io%2fposts%2flog%2fwhat_i_learned%2fc_memory_allocation%2f" target="_blank" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3 0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7 0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1 0-5.2 4.2-9.4 9.4-9.4 2.5 0 4.9 1 6.7 2.8 1.8 1.8 2.8 4.2 2.8 6.7-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2-.2-.3 0-.5.1-.6s.3-.3.4-.5c.2-.1.3-.3.4-.5.1-.2 0-.4 0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg>
        </div>
      </div>
    </a>
    

    
    
    <a class="resp-sharing-button__link" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fEricLim73.github.io%2fposts%2flog%2fwhat_i_learned%2fc_memory_allocation%2f&amp;t=C_Memory_Allocation" target="_blank" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    	<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 140"><path fill-rule="evenodd" d="M60.94 82.314L17 0h20.08l25.85 52.093c.397.927.86 1.888 1.39 2.883.53.994.995 2.02 1.393 3.08.265.4.463.764.596 1.095.13.334.262.63.395.898.662 1.325 1.26 2.618 1.79 3.877.53 1.26.993 2.42 1.39 3.48 1.06-2.254 2.22-4.673 3.48-7.258 1.26-2.585 2.552-5.27 3.877-8.052L103.49 0h18.69L77.84 83.308v53.087h-16.9v-54.08z"></path></svg>
        </div>
      </div>
    </a>
    

    
    
    <a class="resp-sharing-button__link" href="https://telegram.me/share/url?text=C_Memory_Allocation&amp;url=https%3a%2f%2fEricLim73.github.io%2fposts%2flog%2fwhat_i_learned%2fc_memory_allocation%2f" target="_blank" rel="noopener" aria-label="">
      <div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.707 8.475C.275 8.64 0 9.508 0 9.508s.284.867.718 1.03l5.09 1.897 1.986 6.38a1.102 1.102 0 0 0 1.75.527l2.96-2.41a.405.405 0 0 1 .494-.013l5.34 3.87a1.1 1.1 0 0 0 1.046.135 1.1 1.1 0 0 0 .682-.803l3.91-18.795A1.102 1.102 0 0 0 22.5.075L.706 8.475z"/></svg>
        </div>
      </div>
    </a>
    
</div>
  <div class="paginator">
    
    <a class="link" href="https://EricLim73.github.io/posts/log/errors/ubuntu_ethernet_connection_problem/" title="Ubuntu_Ethernet_Connection_Problem">← prev</a>
    
    
    <a></a>
    
  </div>
  <div class="comment">
    
    
    
      <script src="https://giscus.app/client.js"
    data-repo="EricLim73/blogDiscussions"
    data-repo-id="R_kgDOK-ebpA"
    data-category="General"
    data-category-id="DIC_kwDOK-ebpM4CcDSi"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="0"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="transparent_dark"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
  
  </div>
  
  
</main>

    <footer id="footer">
  <div>
    <span>Powered by  <a class=link href=https://gohugo.io target=_blank rel=noopener>Hugo</a> | 
Theme <a class=link href=https://github.com/michaelneuper/hugo-texify3 target=_blank rel=noopener>TeXify3</a>
</span>
  </div>
  <div>
    <span>Copyright © 2024 Eric Lim</span>
  </div>
</footer>

  </div>

  
  <script src='https://EricLim73.github.io/js/script.js' defer></script>

  
  

  
  

  
  

</body>

</html>
